# Corvus Star: Project Wireframe

## ðŸ—ºï¸ Navigation
- **Structure Map**: [docs/architecture/FOLDER_MAP.qmd](docs/architecture/FOLDER_MAP.qmd)
- **Task List**: [.gemini/brain/.../task.md](task.md)

## ðŸ“‚ System Architecture

### ðŸ§  Core Engine (`src/core/`)
The decision-making brain of Corvus Star.
- **Sovereign Engine** (`sv_engine.py`):
    - `run(query)`: Main execution loop for intent resolution.
    - `_init_vector_engine()`: Loads skills and knowledge.
- **Vector Engine** (`engine/vector.py`):
    - `search(query)`: Finds best matching skill/intent.
    - `score_identity(text)`: Validates persona alignment.
- **Dialogue Engine** (`engine/dialogue.py`):
    - `get(persona, intent, context)`: Context-aware phrase retrieval with tag-based scoring and STM.
- **Dispatcher** (`bin/cstar.js`):
    - Node.js CLI entry point. Routes commands via `commander`.
    - **Local Ravens Status**: Performs deterministic health checks without daemon dependency.
- **Cortex Link** (`src/node/cortex_link.js`):
    - TCP bridge between Node.js and the Python Daemon. Standardized on `127.0.0.1`.
- **The Sovereign Daemon** (`src/cstar/core/daemon.py`):
    - Pure WebSockets server acting as a high-speed Pub/Sub message broker.
- **Universal Event Router** (`src/node/core/EventManager.ts` & `src/node/gateway/routes/ws/events.ts`):
    - Multi-tenant WebSocket gateway with singleton-based broadcast routing and ghost-key garbage collection.
- **Cognitive Router** (`src/node/core/CognitiveRouter.ts`):
    - `route(intent)`: Bifurcates traffic between Edge (Ollama) and Core (Gungnir Matrix) based on `requires_core` payload flags.
- **Sovereign SovereignHUD** (`src/cstar/core/tui.py` & `src/core/ui.py`):
    - Reactive Textual UI driven by Daemon broadcasts (`STATE_ODIN`, `STATE_ALFRED_REPORT`).
    - **Telemetry Intercepts**: Real-time visualization of `EDGE_ROUTER` and `CognitiveRouter` activity.
    - **Async Layer** (`ui.py`): Implements `render_loop`, `broadcast`, and `stream_text` with queue-based serialization.

- **Agent Loop** (`src/node/agent_loop.js`):
    - Orchestrator for the Gungnir flight cycle.
- **The Gungnir Calculus** (`src/cstar/core/sprt.py`):
    - Native Python Bernoulli SPRT math engine.
- **Antigravity Bridge** (`src/cstar/core/antigravity_bridge.py`):
    - **Dynamic Discovery**: Auto-routes workloads to optimal Gemini models.
    - **Ghost Protocol**: Resilient exponential backoff for API stability.
- **Muninn** (`src/sentinel/muninn.py`): Memory ledger with HEARTBEAT tracking (`.agent/muninn.pid`).
- **Genesis Bootstrapper** (`src/node/setup.js`):
    - Zero-touch cross-platform installation.
    - **Persona Alignment**: Dynamically honors active persona logging (ODIN/ALFRED).
- **The Gungnir Calculus (Legacy/Global)** (`src/core/`):
    - `metrics.py`: Computes GPHS (Global Project Health Score).
    - `prompt_linter.py`: AST-based validation of .prompty files.
    - `weights.json`: The GPHS weight ledger.
    - **Atomic Cortex** (`src/core/engine/atomic_gpt.py`): Localized Transformer for code analysis (Stub-free; Precision-mocked in tests).
    - **Warden Circuit Breaker**: Custom exception in `atomic_gpt.py` to halt forge loops.
    - **Anomaly Ledger** (`src/data/anomalies_queue.json`): Persistent JSON queue for system drift tracking.
    - **Alfred Overwatch** (`src/core/engine/alfred_observer.py`): Failure pattern guidance daemon.
- **SPRT Verification** (`tests/integration/project_fishtest.py`):
    - `GungnirSPRT`: Statistical significance testing for GPHS deltas.
- **Proxy Skills** (`.agent/skills/`):
    - `ravens.py`, `trace.py`, `heimdall.py`, etc. (Dynamic CLI Entry Points).

### ðŸ¦… The Ravens (`src/sentinel/`)
The autonomous daemon ensuring system health.
- **Bootstrap** (`_bootstrap.py`): Shared environment and Pathlib configuration.
- **Code Sanitizer: Bifrost Gate** (`code_sanitizer.py`):
    - `sanitize_code()`: Auto-repairs indentation, syntax, and markdown fences.
    - `repair_imports()`: Stubs fabricated imports with MagicMocks.
- **Huginn & Muninn** (`main_loop.py`):
    - `daemon_loop()`: Orchestrates the twin ravens (Thought/Memory).
- **Muninn: The Improver** (`src/sentinel/muninn.py`):
    - `run()`: orchestrates parallel scans or triggers **Shadow Forge**.
    - **Shadow Forge Orchestrator**: Host-side Docker lifecycle management (RO Mounts, `docker cp` promotion).
    - **Shadow Workspace Mirroring**: Internal worker logic for ephemeral environment setup.
    - **Debt Slasher**: Review and eviction logic for the anomaly ledger in `wrap_it_up.py`.
- **Sandbox Warden** (`src/sentinel/sandbox_warden.py`):
    - `run_in_sandbox(path, args)`: Executes Python scripts within isolated, resource-capped Docker containers.
- **Docker Runtimes**:
    - `Dockerfile.sentinel`: Full-cycle sandboxing container (Shadow Forge).
    - `Dockerfile.hunter`: Network-enabled discovery container (Skill Hunting).

### ðŸ“‚ Test Infrastructure (`tests/`)
Verification and hardening tools.
- **Ravens Harness** (`ravens_harness.py`): 100-iteration synthetic/mock gauntlet tester.
- **Empire Test Suite** (`tests/empire_tests/`): 40+ companion tests for core/extension tools (Linscott Standard).
- **Response Harvester** (`src/sentinel/harvest_responses.py`): Records live AI data for offline harness.

### ðŸ› ï¸ Tools (`src/tools/`)
Specialized utilities for analysis and repair.
- **Heimdall: The Guardian** (`code_sentinel.py`):
    - `scan(path)`: Static analysis for syntax and security (Python).
- **Heimdall JS: The Sentinel** (`src/tools/js_sentinel.js`):
    - `main()`: Persona-aware ESLint wrapper for Node.js flight deck security.
- **MemoryDB** (`src/core/engine/MemoryDB.py`):
    - Vector-based memory engine with `app_id` partitioning and composite ID namespacing (`app_id::intent_id`).
- **Voice Check: Logic Diagnostic** (`src/tools/voice_check.py`):
    - `main()`: Manual verification of persona dialogue routing and scoring.

### ðŸ§  Synapse (`src/synapse/`)
Connection to the wider network (Knowledge Core).
- **Synapse Sync** (`synapse_sync.py`):
    - `push()`: Uploads local skills to global brain.
    - `pull()`: Updates local cache from global brain.

## ðŸ“ Key Workflows

### 1. Intent Resolution
`User Input` -> `cstar_dispatcher` -> `sv_engine` -> `vector.py` -> `[Sandbox Routing?]` -> `Skill Execution`
- **Sandbox Gate**: If skill is in `skills_db/`, execution is diverted to `SandboxWarden`.

### 2. Autonomous Audit
`Time Trigger` -> `Huginn & Muninn` -> `muninn.py` -> `Heimdall` -> `Report`

### 3. Skill Development
`User Create` -> `.agent/skills/NEW_SKILL.py` -> `c* NEW_SKILL` -> `Available`
